---
import { generateSVGBanner, type BlogPost, type BannerImageConfig } from '~/utils/bannerGenerator';
import { generateAIImage } from '~/utils/aiImageGenerator';

interface Props {
  post: BlogPost;
  config?: BannerImageConfig & {
    useAIImage?: boolean;
  };
  className?: string;
}

const { post, config = {
  width: 1200,
  height: 630,
  style: 'modern',
  colorScheme: 'gradient',
  useAIImage: false
}, className = '' } = Astro.props;

// æ£€æŸ¥æ˜¯å¦å¯ç”¨ AI å›¾ç‰‡ç”Ÿæˆ
const useAIImage = config.useAIImage && import.meta.env.OPENAI_API_KEY;

let bannerContent: string;
let isAIGenerated = false;

if (useAIImage) {
  try {
    // ç”Ÿæˆ AI å›¾ç‰‡
    const aiImageUrl = await generateAIImage(post, {
      size: '1024x1024',
      quality: 'standard',
      style: 'vivid'
    });
    
    // ä½¿ç”¨ AI ç”Ÿæˆçš„å›¾ç‰‡
    bannerContent = `
      <div style="width: 100%; height: 100%; background-image: url('${aiImageUrl}'); background-size: cover; background-position: center; background-repeat: no-repeat; border-radius: 8px;"></div>
    `;
    isAIGenerated = true;
  } catch (error) {
    console.warn('AI image generation failed, using mock images for demo:', error);
    
    // ä½¿ç”¨æ¨¡æ‹Ÿçš„ AI å›¾ç‰‡ä½œä¸ºæ¼”ç¤º - æ ¹æ®æ–‡ç« å…³é”®è¯ç”Ÿæˆç‹¬ç‰¹å›¾ç‰‡
    const mockImages = {
      // æ ¹æ®æ–‡ç« slugç²¾ç¡®åŒ¹é… - æ¯ä¸ªæ–‡ç« éƒ½æœ‰ç‹¬ç‰¹çš„å›¾ç‰‡
      'ai-marketing-revolution': 'https://images.unsplash.com/photo-1551288049-bebda4e38f71?w=1200&h=630&fit=crop&crop=center&q=80', // è¥é”€é©å‘½ - æ•°æ®åˆ†æå›¾è¡¨
      'ai-tools-2025': 'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=1200&h=630&fit=crop&crop=center&q=80', // AIå·¥å…· - å·¥å…·è®¾å¤‡
      'ai-future-decade-keywords': 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?w=1200&h=630&fit=crop&crop=center&q=80', // æœªæ¥å…³é”®è¯ - ç§‘æŠ€æ¦‚å¿µ
      'prompt-engineering': 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=1200&h=630&fit=crop&crop=center&q=80', // Promptå·¥ç¨‹ - ç¼–ç¨‹å­¦ä¹ 
      'ai-model-ranking-2025': 'https://images.unsplash.com/photo-1677442136019-21780ecad995?w=1200&h=630&fit=crop&crop=center&q=80', // AIæ¨¡å‹æ’å - ç¥ç»ç½‘ç»œ
      'ai-copywriting-prompts': 'https://images.unsplash.com/photo-1507003211169-0a1dd7228f2d?w=1200&h=630&fit=crop&crop=center&q=80', // AIæ–‡æ¡ˆ - å†™ä½œåœºæ™¯
      
      // åˆ†ç±»å¤‡ç”¨å›¾ç‰‡
      'AI Marketing': 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=1200&h=630&fit=crop&crop=center&q=80',
      'AI Tools': 'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=1200&h=630&fit=crop&crop=center&q=80',
      'AI Trends': 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?w=1200&h=630&fit=crop&crop=center&q=80',
      'Tech Tutorial': 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=1200&h=630&fit=crop&crop=center&q=80',
      
      // ä¸­æ–‡åˆ†ç±»
      'AI è¥é”€': 'https://images.unsplash.com/photo-1460925895917-afdab827c52f?w=1200&h=630&fit=crop&crop=center&q=80',
      'AI å·¥å…·': 'https://images.unsplash.com/photo-1518709268805-4e9042af2176?w=1200&h=630&fit=crop&crop=center&q=80',
      'AI è¶‹åŠ¿': 'https://images.unsplash.com/photo-1485827404703-89b55fcc595e?w=1200&h=630&fit=crop&crop=center&q=80',
      'æŠ€æœ¯å®è·µ': 'https://images.unsplash.com/photo-1516321318423-f06f85e504b3?w=1200&h=630&fit=crop&crop=center&q=80'
    };
    
    // ä¼˜å…ˆä½¿ç”¨æ–‡ç« slugåŒ¹é…ï¼Œç„¶åä½¿ç”¨åˆ†ç±»åŒ¹é…
    const mockImageUrl = mockImages[post.slug] || mockImages[post.category] || mockImages['AI Marketing'];
    
    bannerContent = `
      <div style="width: 100%; height: 100%; background-image: url('${mockImageUrl}'); background-size: contain; background-position: center; background-repeat: no-repeat; border-radius: 8px; position: relative; background-color: #f8fafc;">
        <div style="position: absolute; top: 10px; right: 10px; background: rgba(0,0,0,0.8); color: white; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 500;">
          ğŸ¤– AI Demo
        </div>
      </div>
    `;
    isAIGenerated = true;
  }
} else {
  bannerContent = generateSVGBanner(post, config);
  isAIGenerated = false;
}
---

<div class={`banner-container ${className}`}>
  <div class="aspect-video rounded-lg overflow-hidden">
    <div class="banner-svg" set:html={bannerContent}></div>
  </div>
</div>

<style>
  .banner-container {
    width: 100%;
    height: 100%;
  }
  
  .banner-svg {
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  
  .banner-svg svg {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }
  
  /* Responsive adjustments */
  @media (max-width: 768px) {
    .banner-svg svg text {
      font-size: 0.8em;
    }
  }
</style>
