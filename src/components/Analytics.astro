---
// Google Analytics 4 ç»„ä»¶
// ä½¿ç”¨æ–¹å¼ï¼šåœ¨ BaseLayout.astro ä¸­å¼•å…¥

const GA_ID = import.meta.env.PUBLIC_GA_ID || 'G-XXXXXXXXXX';  // ä»ç¯å¢ƒå˜é‡è¯»å–
const isDev = import.meta.env.DEV;  // å¼€å‘ç¯å¢ƒä¸åŠ è½½
---

{!isDev && GA_ID && GA_ID !== 'G-XXXXXXXXXX' && (
  <>
    <!-- Google tag (gtag.js) -->
    <script async src={`https://www.googletagmanager.com/gtag/js?id=${GA_ID}`}></script>
    <script is:inline define:vars={{ GA_ID }}>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());
      gtag('config', GA_ID, {
        page_path: window.location.pathname,
        anonymize_ip: true,  // åŒ¿å IPï¼ˆGDPR åˆè§„ï¼‰
      });
      
      // è‡ªå®šä¹‰äº‹ä»¶è¿½è¸ª
      
      // è¿½è¸ªå¤–é“¾ç‚¹å‡»
      document.addEventListener('click', (e) => {
        const target = e.target.closest('a');
        if (target && target.hostname !== window.location.hostname) {
          gtag('event', 'click', {
            event_category: 'outbound',
            event_label: target.href,
            transport_type: 'beacon'
          });
        }
      });
      
      // è¿½è¸ª Newsletter è®¢é˜…
      window.addEventListener('newsletter_subscribed', (e) => {
        gtag('event', 'sign_up', {
          event_category: 'engagement',
          event_label: 'newsletter',
          value: 1
        });
      });
      
      // è¿½è¸ªæ–‡ç« é˜…è¯»æ·±åº¦
      let maxScroll = 0;
      const milestones = [25, 50, 75, 90];
      let reported = new Set();
      
      window.addEventListener('scroll', () => {
        const scrollPercent = Math.round(
          (window.scrollY / (document.documentElement.scrollHeight - window.innerHeight)) * 100
        );
        
        if (scrollPercent > maxScroll) {
          maxScroll = scrollPercent;
          
          milestones.forEach(milestone => {
            if (scrollPercent >= milestone && !reported.has(milestone)) {
              reported.add(milestone);
              gtag('event', 'scroll', {
                event_category: 'engagement',
                event_label: `${milestone}%`,
                value: milestone
              });
            }
          });
        }
      });
    </script>
  </>
)}

<!-- å¼€å‘ç¯å¢ƒæç¤º -->
{isDev && (
  <script is:inline>
    console.log('ğŸ“Š Analytics: Disabled in development mode');
  </script>
)}

